#!/usr/bin/env node

/**
 * Coverage Threshold Check Script
 * 
 * This script checks if the test coverage meets the required 80% threshold.
 * It reads the coverage-summary.json file generated by vitest and validates
 * that lines, statements, functions, and branches all meet the threshold.
 * 
 * Usage: node scripts/check-coverage.js
 * 
 * Exit codes:
 *   0 - All coverage thresholds met
 *   1 - One or more coverage thresholds not met
 *   2 - Error reading coverage file
 */

const fs = require('fs');
const path = require('path');

const COVERAGE_FILE = path.join(__dirname, '..', 'coverage', 'coverage-summary.json');
const THRESHOLD = 80;

function checkCoverage() {
  // Check if coverage file exists
  if (!fs.existsSync(COVERAGE_FILE)) {
    console.error('‚ùå Coverage file not found:', COVERAGE_FILE);
    console.error('Please run "npm run test:coverage" first to generate coverage report.');
    process.exit(2);
  }

  // Read coverage data
  let coverageData;
  try {
    const fileContent = fs.readFileSync(COVERAGE_FILE, 'utf8');
    coverageData = JSON.parse(fileContent);
  } catch (error) {
    console.error('‚ùå Error reading coverage file:', error.message);
    process.exit(2);
  }

  // Extract coverage percentages
  const { total } = coverageData;
  const linesPct = total.lines.pct;
  const statementsPct = total.statements.pct;
  const functionsPct = total.functions.pct;
  const branchesPct = total.branches.pct;

  // Display coverage report
  console.log('\nüìä Coverage Report:');
  console.log('‚îÄ'.repeat(50));
  console.log(`  Lines:      ${linesPct.toFixed(2)}%`);
  console.log(`  Statements: ${statementsPct.toFixed(2)}%`);
  console.log(`  Functions:  ${functionsPct.toFixed(2)}%`);
  console.log(`  Branches:   ${branchesPct.toFixed(2)}%`);
  console.log('‚îÄ'.repeat(50));

  // Check thresholds
  let failed = false;

  if (linesPct < THRESHOLD) {
    console.log(`‚ùå Lines coverage ${linesPct.toFixed(2)}% is below ${THRESHOLD}% threshold`);
    failed = true;
  } else {
    console.log(`‚úÖ Lines coverage ${linesPct.toFixed(2)}% meets ${THRESHOLD}% threshold`);
  }

  if (statementsPct < THRESHOLD) {
    console.log(`‚ùå Statements coverage ${statementsPct.toFixed(2)}% is below ${THRESHOLD}% threshold`);
    failed = true;
  } else {
    console.log(`‚úÖ Statements coverage ${statementsPct.toFixed(2)}% meets ${THRESHOLD}% threshold`);
  }

  if (functionsPct < THRESHOLD) {
    console.log(`‚ùå Functions coverage ${functionsPct.toFixed(2)}% is below ${THRESHOLD}% threshold`);
    failed = true;
  } else {
    console.log(`‚úÖ Functions coverage ${functionsPct.toFixed(2)}% meets ${THRESHOLD}% threshold`);
  }

  if (branchesPct < THRESHOLD) {
    console.log(`‚ùå Branches coverage ${branchesPct.toFixed(2)}% is below ${THRESHOLD}% threshold`);
    failed = true;
  } else {
    console.log(`‚úÖ Branches coverage ${branchesPct.toFixed(2)}% meets ${THRESHOLD}% threshold`);
  }

  console.log('‚îÄ'.repeat(50));

  if (failed) {
    console.log('\n‚ùå Coverage check failed. Please add more tests to reach 80% coverage.\n');
    process.exit(1);
  }

  console.log('\n‚úÖ All coverage thresholds met! üéâ\n');
  process.exit(0);
}

// Run the check
checkCoverage();
